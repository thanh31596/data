<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Understanding Temporal Fusion Transformers</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script>
        // Fallback loader for D3.js
        window.addEventListener('load', function() {
            if (typeof d3 === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js';
                script.onload = function() {
                    console.log('D3.js loaded via fallback');
                    initArchitecture();
                };
                document.head.appendChild(script);
            }
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Helvetica', Arial, sans-serif;
            background: white;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 2px solid #9b59b6;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.24em;
            color: #2c3e50;
            font-weight: 300;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 0.96em;
            color: #7f8c8d;
        }
        
        .tab-container {
            margin-bottom: 30px;
        }
        
        .tab-nav {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .tab-button {
            background: #f8f9fa;
            border: none;
            padding: 15px 20px;
            cursor: pointer;
            font-size: 12.8px;
            font-family: 'Helvetica', Arial, sans-serif;
            color: #495057;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s;
            flex: 1;
            min-width: 140px;
        }
        
        .tab-button:hover {
            background: #e9ecef;
            color: #2c3e50;
        }
        
        .tab-button.active {
            background: #9b59b6;
            color: white;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
            min-height: 500px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 0 0 10px 10px;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-title {
            font-size: 1.76em;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 300;
        }
        
        .section-subtitle {
            font-size: 1.28em;
            color: #34495e;
            margin-bottom: 15px;
            margin-top: 25px;
        }
        
        .business-question {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        .business-question h3 {
            color: white;
            margin-bottom: 15px;
            font-size: 1.28em;
        }
        
        .visualization-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .control-btn {
            background: #9b59b6;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 11.2px;
            transition: all 0.3s;
            font-family: 'Helvetica', Arial, sans-serif;
        }
        
        .control-btn:hover {
            background: #8e44ad;
            transform: translateY(-2px);
        }
        
        .control-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .key-concepts {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
        }
        
        .key-concepts h3 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 1.28em;
        }
        
        .concept-list {
            list-style: none;
            padding: 0;
        }
        
        .concept-list li {
            margin: 10px 0;
            padding-left: 20px;
            position: relative;
            font-size: 0.88em;
        }
        
        .concept-list li:before {
            content: "→";
            position: absolute;
            left: 0;
            color: #ffc107;
            font-weight: bold;
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .comparison-item {
            background: white;
            border: 2px solid #9b59b6;
            border-radius: 10px;
            padding: 20px;
        }
        
        .comparison-item h4 {
            color: #8e44ad;
            margin-bottom: 15px;
            font-size: 1.04em;
        }
        
        .comparison-item p, .comparison-item li {
            font-size: 0.88em;
        }
        
        .comparison-item ul {
            list-style: disc;
            padding-left: 20px;
        }
        
        p {
            font-size: 0.88em;
            margin-bottom: 15px;
        }
        
        /* TFT specific styles */
        .architecture-svg {
            width: 100%;
            height: 700px;
            background: white;
        }
        
        .component-box {
            fill: #f8f9fa;
            stroke: #9b59b6;
            stroke-width: 2;
            rx: 10;
        }
        
        .component-text {
            fill: #2c3e50;
            font-size: 14px;
            text-anchor: middle;
            font-family: 'Helvetica', Arial, sans-serif;
        }
        
        .flow-arrow {
            stroke: #9b59b6;
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }
        
        .time-series-chart {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.88em;
        }
        
        .data-table th, .data-table td {
            padding: 10px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .data-table th {
            background: #8e44ad;
            color: white;
            font-weight: bold;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .static-feature {
            background: #e8f4fd !important;
        }
        
        .time-varying {
            background: #e8f5e8 !important;
        }
        
        .target-value {
            background: #ffe8e8 !important;
            font-weight: bold;
        }
        
        .feature-list {
            list-style: none;
            padding: 0;
        }
        
        .feature-list li {
            margin: 8px 0;
            padding-left: 25px;
            position: relative;
        }
        
        .feature-list li:before {
            content: "•";
            position: absolute;
            left: 10px;
            color: #9b59b6;
            font-weight: bold;
        }
        
        table {
            margin: 20px auto;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
        }
        
        th {
            background: #8e44ad;
            color: white;
        }
        
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            line-height: 1.4;
        }
        
        h5 {
            font-size: 1.04em;
            color: #34495e;
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .attention-heatmap {
            margin: 20px 0;
            text-align: center;
        }
        
        .example-container {
            background: #e8f5e8;
            border: 2px solid #27ae60;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .example-container h4 {
            color: #27ae60;
            margin-bottom: 15px;
            font-size: 1.04em;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: white;
            border: 2px solid #27ae60;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 1.6em;
            font-weight: bold;
            color: #27ae60;
            margin: 10px 0;
        }
        
        @media (max-width: 768px) {
            .tab-nav {
                flex-direction: column;
            }
            
            .tab-button {
                flex: none;
                min-width: none;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .comparison-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Forecast visualization styles */
        .forecast-line {
            fill: none;
            stroke-width: 2;
        }
        
        .actual-line {
            stroke: #3498db;
        }
        
        .prediction-line {
            stroke: #e74c3c;
            stroke-dasharray: 5,5;
        }
        
        .confidence-band {
            fill: #3498db;
            opacity: 0.2;
        }
        
        .axis {
            font-size: 12px;
        }
        
        .axis line,
        .axis path {
            stroke: #ddd;
        }
        
        .grid line {
            stroke: #f0f0f0;
            stroke-dasharray: 2,2;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Understanding Temporal Fusion Transformers</h1>
            <p>Advanced Time Series Forecasting with Interpretable AI</p>
            <p style="font-size: 0.85em; color: #95a5a6; margin-top: 10px;">Interactive visualization for DATA4800 & DATA5000</p>
        </div>
        
        <div class="tab-container">
            <div class="tab-nav">
                <button class="tab-button active" onclick="showTab(0)">Overview</button>
                <button class="tab-button" onclick="showTab(1)">Architecture</button>
                <button class="tab-button" onclick="showTab(2)">Components</button>
                <button class="tab-button" onclick="showTab(3)">Real Example</button>
            </div>
            
            <!-- Tab 1: Overview -->
            <div class="tab-content active">
                <div class="section-title">What is a Temporal Fusion Transformer?</div>
                
                <div class="business-question">
                    <h3>Business Problem</h3>
                    <p>How can we accurately forecast time series with multiple inputs while understanding which factors drive predictions?</p>
                </div>
                
                <p>Temporal Fusion Transformer (TFT) is a deep learning architecture specifically designed for multi-horizon time series forecasting with built-in interpretability.</p>
                
                <div class="comparison-grid">
                    <div class="comparison-item">
                        <h4>Traditional Time Series Methods</h4>
                        <ul>
                            <li>ARIMA, Prophet, etc.</li>
                            <li>Limited to univariate or simple multivariate</li>
                            <li>Difficult to incorporate static features</li>
                            <li>Black box predictions</li>
                            <li>Fixed forecast horizons</li>
                        </ul>
                    </div>
                    <div class="comparison-item">
                        <h4>TFT Advantages</h4>
                        <ul>
                            <li>Handles complex multivariate inputs</li>
                            <li>Incorporates static & time-varying features</li>
                            <li>Built-in variable importance</li>
                            <li>Interpretable attention patterns</li>
                            <li>Multi-horizon forecasting</li>
                        </ul>
                    </div>
                </div>
                
                <div class="key-concepts">
                    <h3>Key TFT Innovations</h3>
                    <ul class="concept-list">
                        <li><strong>Variable Selection Networks:</strong> Automatically selects relevant features</li>
                        <li><strong>Gated Residual Networks:</strong> Efficient information flow with skip connections</li>
                        <li><strong>Temporal Self-Attention:</strong> Captures long-range temporal dependencies</li>
                        <li><strong>Interpretable Multi-Head Attention:</strong> Shows what the model focuses on</li>
                        <li><strong>Quantile Outputs:</strong> Provides prediction intervals, not just point forecasts</li>
                    </ul>
                </div>
            </div>
            
            <!-- Tab 2: Architecture -->
            <div class="tab-content">
                <div class="section-title">TFT Architecture</div>
                
                <div class="controls">
                    <button class="control-btn" onclick="animateDataFlow()">Show Data Flow</button>
                    <button class="control-btn" onclick="resetAnimation()">Reset</button>
                </div>
                
                <div class="visualization-container">
                    <svg id="architecture-svg" class="architecture-svg"></svg>
                </div>
                
                <p style="text-align: center; margin-top: 20px;">
                    The TFT processes static features, past time series, and known future inputs to generate multi-step forecasts
                </p>
            </div>
            
            <!-- Tab 3: Components -->
            <div class="tab-content">
                <div class="section-title">Key Components Explained</div>
                
                <div class="section-subtitle">1. Variable Selection Networks</div>
                <div class="visualization-container">
                    <p>TFT uses separate variable selection for different input types:</p>
                    <div class="comparison-grid">
                        <div class="comparison-item">
                            <h4>Static Features</h4>
                            <p>Context that doesn't change over time</p>
                            <ul>
                                <li>Store ID</li>
                                <li>Product category</li>
                                <li>Geographic location</li>
                            </ul>
                        </div>
                        <div class="comparison-item">
                            <h4>Time-Varying Known</h4>
                            <p>Future values we know in advance</p>
                            <ul>
                                <li>Day of week</li>
                                <li>Holidays</li>
                                <li>Promotional events</li>
                            </ul>
                        </div>
                        <div class="comparison-item">
                            <h4>Time-Varying Unknown</h4>
                            <p>Past observed values only</p>
                            <ul>
                                <li>Historical sales</li>
                                <li>Past prices</li>
                                <li>Previous demand</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="section-subtitle">2. Gated Residual Network (GRN)</div>
                <div class="example-container">
                    <h4>GRN Formula</h4>
                    <pre>
GRN(a, c) = LayerNorm(a + GLU(η₁))
where:
  η₁ = W₁,₁ η₂ + b₁,₁
  η₂ = ELU(W₂,₁ a + W₂,₂ c + b₂,₁)
  GLU = Gated Linear Unit for flexible representation
                    </pre>
                    <p>This allows the model to adaptively suppress or enhance features based on context</p>
                </div>
                
                <div class="section-subtitle">3. Temporal Attention</div>
                <div class="visualization-container">
                    <p>Multi-head attention learns different temporal patterns:</p>
                    <div id="attention-patterns"></div>
                </div>
            </div>
            
            <!-- Tab 4: Real Example -->
            <div class="tab-content">
                <div class="section-title">Real Example: Retail Sales Forecasting</div>
                
                <div class="business-question">
                    <h3>Scenario: Forecast next 7 days of product sales</h3>
                    <p>Input: 30 days of historical data + store features + calendar events</p>
                    <p style="font-size: 0.85em; margin-top: 10px;">Application: Inventory management and staff scheduling</p>
                </div>
                
                <div class="controls">
                    <button class="control-btn" onclick="startDetailedExample()">Step Through Processing</button>
                    <button class="control-btn" onclick="resetExample()">Reset</button>
                </div>
                
                <div id="step-container" style="display: none;">
                    <div class="visualization-container">
                        <h4 id="step-title">Step 1: Input Data Preparation</h4>
                        <div id="step-content"></div>
                    </div>
                    
                    <div class="controls" style="margin-top: 20px;">
                        <button class="control-btn" id="prev-step" onclick="previousStep()" disabled>Previous</button>
                        <button class="control-btn" id="next-step" onclick="nextStep()">Next Step</button>
                    </div>
                </div>
                
                <div id="forecast-visualization" style="display: none; margin-top: 20px;">
                    <div class="visualization-container">
                        <h4>Forecast Results</h4>
                        <svg id="forecast-chart" width="100%" height="400"></svg>
                    </div>
                </div>
                
                <div id="final-result" style="display: none; margin-top: 20px;"></div>
            </div>
        </div>
    </div>
    
    <script>
        // Check if D3 is loaded
        if (typeof d3 === 'undefined') {
            console.error('D3.js failed to load. Please check your internet connection.');
            document.body.innerHTML = '<div style="text-align: center; padding: 50px;"><h2>Error: D3.js library failed to load</h2><p>Please refresh the page or check your internet connection.</p></div>';
        }
        
        // Tab functionality
        function showTab(index) {
            const tabs = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach((tab, i) => {
                tab.classList.toggle('active', i === index);
            });
            
            contents.forEach((content, i) => {
                content.classList.toggle('active', i === index);
            });
            
            // Initialize visualizations when tabs are shown
            if (index === 1) initArchitecture();
            if (index === 2) initComponents();
            if (index === 3) initExample();
        }
        
        // Architecture visualization
        function initArchitecture() {
            if (typeof d3 === 'undefined') {
                console.error('D3 is not available');
                return;
            }
            
            const svg = d3.select('#architecture-svg');
            svg.selectAll("*").remove();
            
            const width = svg.node().getBoundingClientRect().width;
            const height = 700;
            
            // Define arrow marker
            svg.append('defs').append('marker')
                .attr('id', 'arrowhead')
                .attr('viewBox', '0 -5 10 10')
                .attr('refX', 10)
                .attr('refY', 0)
                .attr('markerWidth', 5)
                .attr('markerHeight', 5)
                .attr('orient', 'auto')
                .append('path')
                .attr('d', 'M 0,-5 L 10,0 L 0,5')
                .attr('fill', '#9b59b6');
            
            // Component positions
            const components = [
                // Input processing
                {id: 'static', x: width/4, y: 650, w: 150, h: 40, text: 'Static Features'},
                {id: 'past', x: width/2, y: 650, w: 180, h: 40, text: 'Past Time Series'},
                {id: 'future', x: 3*width/4, y: 650, w: 180, h: 40, text: 'Future Known'},
                
                // Variable selection
                {id: 'vs_static', x: width/4, y: 550, w: 140, h: 40, text: 'Variable Selection'},
                {id: 'vs_past', x: width/2, y: 550, w: 140, h: 40, text: 'Variable Selection'},
                {id: 'vs_future', x: 3*width/4, y: 550, w: 140, h: 40, text: 'Variable Selection'},
                
                // LSTM encoder
                {id: 'lstm', x: width/2, y: 450, w: 200, h: 50, text: 'LSTM Encoder'},
                
                // Static enrichment
                {id: 'enrichment', x: width/2, y: 350, w: 250, h: 50, text: 'Static Enrichment'},
                
                // Temporal attention
                {id: 'attention', x: width/2, y: 250, w: 280, h: 60, text: 'Temporal Self-Attention'},
                
                // Position-wise FF
                {id: 'ff', x: width/2, y: 150, w: 220, h: 50, text: 'Position-wise Feed Forward'},
                
                // Output
                {id: 'output', x: width/2, y: 50, w: 200, h: 40, text: 'Quantile Outputs'}
            ];
            
            // Draw components
            const g = svg.append('g');
            
            components.forEach(comp => {
                g.append('rect')
                    .attr('class', 'component-box')
                    .attr('x', comp.x - comp.w/2)
                    .attr('y', comp.y - comp.h/2)
                    .attr('width', comp.w)
                    .attr('height', comp.h);
                
                g.append('text')
                    .attr('class', 'component-text')
                    .attr('x', comp.x)
                    .attr('y', comp.y + 5)
                    .text(comp.text);
            });
            
            // Draw connections
            const connections = [
                ['static', 'vs_static'],
                ['past', 'vs_past'],
                ['future', 'vs_future'],
                ['vs_past', 'lstm'],
                ['vs_future', 'lstm'],
                ['lstm', 'enrichment'],
                ['vs_static', 'enrichment'],
                ['enrichment', 'attention'],
                ['attention', 'ff'],
                ['ff', 'output']
            ];
            
            connections.forEach(([from, to]) => {
                const fromComp = components.find(c => c.id === from);
                const toComp = components.find(c => c.id === to);
                
                g.append('line')
                    .attr('class', 'flow-arrow')
                    .attr('x1', fromComp.x)
                    .attr('y1', fromComp.y - fromComp.h/2)
                    .attr('x2', toComp.x)
                    .attr('y2', toComp.y + toComp.h/2);
            });
            
            // Add skip connections
            g.append('path')
                .attr('class', 'flow-arrow')
                .attr('d', `M ${width/2 + 140} ${400} 
                           Q ${width/2 + 200} ${325} ${width/2 + 140} ${220}`)
                .style('stroke-dasharray', '5,5');
        }
        
        // Components visualization
        function initComponents() {
            drawAttentionPatterns();
        }
        
        function drawAttentionPatterns() {
            if (typeof d3 === 'undefined') return;
            
            const container = d3.select('#attention-patterns');
            container.selectAll("*").remove();
            
            const patterns = [
                {name: 'Head 1: Weekly Pattern', data: [0.1, 0.2, 0.3, 0.8, 0.9, 0.7, 0.3]},
                {name: 'Head 2: Trend Focus', data: [0.9, 0.8, 0.7, 0.6, 0.5, 0.4, 0.3]},
                {name: 'Head 3: Recent Focus', data: [0.1, 0.1, 0.2, 0.3, 0.5, 0.8, 0.95]},
                {name: 'Head 4: Holiday Impact', data: [0.2, 0.2, 0.9, 0.2, 0.2, 0.2, 0.8]}
            ];
            
            patterns.forEach(pattern => {
                const div = container.append('div')
                    .style('margin', '20px 0');
                
                div.append('h5').text(pattern.name);
                
                const svg = div.append('svg')
                    .attr('width', '100%')
                    .attr('height', 60);
                
                const width = 400;
                const barWidth = width / pattern.data.length - 5;
                
                svg.selectAll('rect')
                    .data(pattern.data)
                    .enter()
                    .append('rect')
                    .attr('x', (d, i) => i * (barWidth + 5))
                    .attr('y', d => 50 - d * 40)
                    .attr('width', barWidth)
                    .attr('height', d => d * 40)
                    .attr('fill', '#9b59b6')
                    .attr('opacity', 0.8);
            });
        }
        
        // Example functionality
        let currentStep = 0;
        const exampleSteps = [
            {
                title: "Step 1: Input Data Preparation",
                content: function() {
                    return `
                        <p>Preparing multi-modal input data for the store's laptop sales:</p>
                        
                        <h5>Static Features (Store Characteristics)</h5>
                        <table class="data-table">
                            <tr>
                                <th>Feature</th>
                                <th>Value</th>
                                <th>Embedding</th>
                            </tr>
                            <tr class="static-feature">
                                <td>Store ID</td>
                                <td>Store_042</td>
                                <td>[0.23, -0.45, 0.67, ...]</td>
                            </tr>
                            <tr class="static-feature">
                                <td>Location</td>
                                <td>Urban</td>
                                <td>[0.81, 0.32, -0.15, ...]</td>
                            </tr>
                            <tr class="static-feature">
                                <td>Store Size</td>
                                <td>Large</td>
                                <td>[0.92, 0.18, 0.44, ...]</td>
                            </tr>
                        </table>
                        
                        <h5>Time-Varying Features (Last 7 Days)</h5>
                        <table class="data-table">
                            <tr>
                                <th>Date</th>
                                <th>Sales</th>
                                <th>Price</th>
                                <th>Day of Week</th>
                                <th>Promotion</th>
                            </tr>
                            <tr>
                                <td>2024-01-15</td>
                                <td class="target-value">42</td>
                                <td>$899</td>
                                <td>Monday</td>
                                <td>No</td>
                            </tr>
                            <tr>
                                <td>2024-01-16</td>
                                <td class="target-value">38</td>
                                <td>$899</td>
                                <td>Tuesday</td>
                                <td>No</td>
                            </tr>
                            <tr>
                                <td>2024-01-17</td>
                                <td class="target-value">45</td>
                                <td>$899</td>
                                <td>Wednesday</td>
                                <td>No</td>
                            </tr>
                            <tr>
                                <td>2024-01-18</td>
                                <td class="target-value">52</td>
                                <td>$899</td>
                                <td>Thursday</td>
                                <td>No</td>
                            </tr>
                            <tr style="background: #fff9e8;">
                                <td>2024-01-19</td>
                                <td class="target-value">78</td>
                                <td>$849</td>
                                <td>Friday</td>
                                <td>Yes</td>
                            </tr>
                            <tr style="background: #fff9e8;">
                                <td>2024-01-20</td>
                                <td class="target-value">95</td>
                                <td>$849</td>
                                <td>Saturday</td>
                                <td>Yes</td>
                            </tr>
                            <tr>
                                <td>2024-01-21</td>
                                <td class="target-value">72</td>
                                <td>$899</td>
                                <td>Sunday</td>
                                <td>No</td>
                            </tr>
                        </table>
                        <p style="font-style: italic; color: #7f8c8d;">Note: Yellow rows indicate promotional days with price reduction</p>
                    `;
                }
            },
            {
                title: "Step 2: Variable Selection",
                content: function() {
                    return `
                        <p>TFT automatically selects the most relevant features for forecasting:</p>
                        
                        <div class="metric-grid">
                            <div class="metric-card">
                                <h5>Past Sales</h5>
                                <div class="metric-value">0.89</div>
                                <p>Importance Score</p>
                            </div>
                            <div class="metric-card">
                                <h5>Day of Week</h5>
                                <div class="metric-value">0.76</div>
                                <p>Importance Score</p>
                            </div>
                            <div class="metric-card">
                                <h5>Promotion</h5>
                                <div class="metric-value">0.92</div>
                                <p>Importance Score</p>
                            </div>
                            <div class="metric-card">
                                <h5>Price</h5>
                                <div class="metric-value">0.68</div>
                                <p>Importance Score</p>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0;">
                            <h5>Variable Selection Network Output</h5>
                            <pre>
Selected Features Vector: [0.89, 0.76, 0.92, 0.68, 0.45, 0.23, ...]
Gating Weights: softmax([1.2, 0.9, 1.4, 0.7, ...])
                            </pre>
                            <p>Features with higher weights have more influence on predictions</p>
                        </div>
                    `;
                }
            },
            {
                title: "Step 3: LSTM Encoding",
                content: function() {
                    return `
                        <p>LSTM processes the temporal sequence to capture patterns:</p>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <h5>LSTM Hidden States (Simplified 4D)</h5>
                            <table style="margin: 10px auto; font-size: 0.85em;">
                                <tr>
                                    <th>Time Step</th>
                                    <th>Sales</th>
                                    <th>Hidden State</th>
                                    <th>Pattern Detected</th>
                                </tr>
                                <tr>
                                    <td>t-6 (Mon)</td>
                                    <td>42</td>
                                    <td>[0.32, -0.21, 0.45, 0.18]</td>
                                    <td>Weekday baseline</td>
                                </tr>
                                <tr>
                                    <td>t-5 (Tue)</td>
                                    <td>38</td>
                                    <td>[0.28, -0.25, 0.41, 0.15]</td>
                                    <td>Low weekday</td>
                                </tr>
                                <tr>
                                    <td>t-4 (Wed)</td>
                                    <td>45</td>
                                    <td>[0.35, -0.18, 0.48, 0.22]</td>
                                    <td>Mid-week rise</td>
                                </tr>
                                <tr>
                                    <td>t-3 (Thu)</td>
                                    <td>52</td>
                                    <td>[0.42, -0.12, 0.55, 0.28]</td>
                                    <td>Pre-weekend uptick</td>
                                </tr>
                                <tr style="background: #e8f5e8;">
                                    <td>t-2 (Fri)</td>
                                    <td>78</td>
                                    <td>[0.68, 0.15, 0.82, 0.45]</td>
                                    <td>Promotion + Weekend</td>
                                </tr>
                                <tr style="background: #e8f5e8;">
                                    <td>t-1 (Sat)</td>
                                    <td>95</td>
                                    <td>[0.85, 0.32, 0.94, 0.58]</td>
                                    <td>Peak sales</td>
                                </tr>
                                <tr>
                                    <td>t-0 (Sun)</td>
                                    <td>72</td>
                                    <td>[0.62, 0.08, 0.71, 0.38]</td>
                                    <td>Weekend decline</td>
                                </tr>
                            </table>
                        </div>
                        
                        <p style="margin-top: 20px;">The LSTM learns that promotions on Friday/Saturday drive significant sales increases</p>
                    `;
                }
            },
            {
                title: "Step 4: Temporal Attention",
                content: function() {
                    return `
                        <p>Self-attention identifies which past time steps are most relevant for each future prediction:</p>
                        
                        <div class="attention-heatmap">
                            <h5>Attention Weights for 7-Day Forecast</h5>
                            <svg id="attention-heatmap" width="500" height="300"></svg>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h5>Key Attention Insights:</h5>
                            <ul class="feature-list">
                                <li>Monday forecast heavily attends to previous Monday (weekly pattern)</li>
                                <li>Weekend forecasts focus on recent Friday-Saturday promotion</li>
                                <li>All days attend to the general trend over the past week</li>
                                <li>Promotion days (Fri/Sat) receive highest attention weights</li>
                            </ul>
                        </div>
                        
                        <pre style="margin-top: 20px;">
Attention Score Example (for Monday forecast):
Previous Monday:    0.42 (high - same day pattern)
Previous Tuesday:   0.15 (medium - weekday baseline)
Previous Friday:    0.08 (low - different pattern)
Previous Saturday:  0.05 (low - different pattern)
                        </pre>
                    `;
                }
            },
            {
                title: "Step 5: Quantile Predictions",
                content: function() {
                    return `
                        <p>TFT generates multiple quantiles for uncertainty estimation:</p>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <h5>7-Day Forecast with Confidence Intervals</h5>
                            <table class="data-table">
                                <tr>
                                    <th>Date</th>
                                    <th>Day</th>
                                    <th>10th %ile</th>
                                    <th>50th %ile (Median)</th>
                                    <th>90th %ile</th>
                                    <th>Known Events</th>
                                </tr>
                                <tr>
                                    <td>2024-01-22</td>
                                    <td>Monday</td>
                                    <td>38</td>
                                    <td class="target-value">44</td>
                                    <td>52</td>
                                    <td>-</td>
                                </tr>
                                <tr>
                                    <td>2024-01-23</td>
                                    <td>Tuesday</td>
                                    <td>35</td>
                                    <td class="target-value">41</td>
                                    <td>48</td>
                                    <td>-</td>
                                </tr>
                                <tr>
                                    <td>2024-01-24</td>
                                    <td>Wednesday</td>
                                    <td>40</td>
                                    <td class="target-value">47</td>
                                    <td>55</td>
                                    <td>-</td>
                                </tr>
                                <tr>
                                    <td>2024-01-25</td>
                                    <td>Thursday</td>
                                    <td>45</td>
                                    <td class="target-value">53</td>
                                    <td>62</td>
                                    <td>-</td>
                                </tr>
                                <tr style="background: #e8f5e8;">
                                    <td>2024-01-26</td>
                                    <td>Friday</td>
                                    <td>68</td>
                                    <td class="target-value">82</td>
                                    <td>98</td>
                                    <td>Promotion</td>
                                </tr>
                                <tr style="background: #e8f5e8;">
                                    <td>2024-01-27</td>
                                    <td>Saturday</td>
                                    <td>85</td>
                                    <td class="target-value">102</td>
                                    <td>120</td>
                                    <td>Promotion</td>
                                </tr>
                                <tr>
                                    <td>2024-01-28</td>
                                    <td>Sunday</td>
                                    <td>65</td>
                                    <td class="target-value">75</td>
                                    <td>88</td>
                                    <td>-</td>
                                </tr>
                            </table>
                        </div>
                        
                        <p style="margin-top: 20px;">The model predicts higher sales for the upcoming promotional weekend based on learned patterns</p>
                    `;
                }
            },
            {
                title: "Step 6: Interpretability Output",
                content: function() {
                    return `
                        <p>TFT provides comprehensive interpretability insights:</p>
                        
                        <div class="example-container">
                            <h4>Variable Importance Analysis</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <h5>Static Features</h5>
                                    <ul class="feature-list">
                                        <li>Store Size: 0.72</li>
                                        <li>Location Type: 0.68</li>
                                        <li>Store ID: 0.45</li>
                                    </ul>
                                </div>
                                <div>
                                    <h5>Time-Varying Features</h5>
                                    <ul class="feature-list">
                                        <li>Historical Sales: 0.89</li>
                                        <li>Promotion Flag: 0.92</li>
                                        <li>Day of Week: 0.76</li>
                                        <li>Price: 0.68</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: #ffe8e8; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: center;">
                            <h4>Forecast Summary</h4>
                            <p style="font-size: 1.2em;"><strong>Next Week Total: 494 units (±45)</strong></p>
                            <p>Peak Day: Saturday (102 units during promotion)</p>
                            <p>Confidence: 85% (based on historical accuracy)</p>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h5>Business Recommendations:</h5>
                            <ul class="feature-list">
                                <li>Increase inventory for Friday/Saturday promotion (180+ units)</li>
                                <li>Schedule additional staff for weekend peak</li>
                                <li>Consider extending promotion to Thursday (53 predicted sales)</li>
                                <li>Monitor Tuesday as potential low point (41 units)</li>
                            </ul>
                        </div>
                    `;
                }
            }
        ];
        
        function initExample() {
            currentStep = 0;
            document.getElementById('step-container').style.display = 'none';
            document.getElementById('forecast-visualization').style.display = 'none';
            document.getElementById('final-result').style.display = 'none';
        }
        
        function startDetailedExample() {
            currentStep = 0;
            document.getElementById('step-container').style.display = 'block';
            showExampleStep();
        }
        
        function showExampleStep() {
            const step = exampleSteps[currentStep];
            document.getElementById('step-title').textContent = step.title;
            document.getElementById('step-content').innerHTML = step.content();
            
            // Update button states
            document.getElementById('prev-step').disabled = currentStep === 0;
            document.getElementById('next-step').textContent = 
                currentStep === exampleSteps.length - 1 ? 'Show Forecast' : 'Next Step';
            
            // Special handling for attention heatmap
            if (currentStep === 3) {
                drawAttentionHeatmap();
            }
        }
        
        function nextStep() {
            if (currentStep < exampleSteps.length - 1) {
                currentStep++;
                showExampleStep();
            } else {
                showForecastVisualization();
            }
        }
        
        function previousStep() {
            if (currentStep > 0) {
                currentStep--;
                showExampleStep();
            }
        }
        
        function resetExample() {
            currentStep = 0;
            document.getElementById('step-container').style.display = 'none';
            document.getElementById('forecast-visualization').style.display = 'none';
            document.getElementById('final-result').style.display = 'none';
        }
        
        function drawAttentionHeatmap() {
            if (typeof d3 === 'undefined') return;
            
            const svg = d3.select('#attention-heatmap');
            svg.selectAll("*").remove();
            
            const data = [
                [0.42, 0.15, 0.12, 0.10, 0.08, 0.05, 0.08],
                [0.18, 0.38, 0.14, 0.11, 0.07, 0.06, 0.06],
                [0.15, 0.16, 0.35, 0.12, 0.08, 0.07, 0.07],
                [0.12, 0.13, 0.15, 0.32, 0.10, 0.09, 0.09],
                [0.08, 0.09, 0.10, 0.12, 0.28, 0.25, 0.08],
                [0.06, 0.07, 0.08, 0.10, 0.24, 0.35, 0.10],
                [0.10, 0.11, 0.12, 0.13, 0.14, 0.15, 0.25]
            ];
            
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const cellSize = 40;
            const margin = {top: 50, right: 50, bottom: 50, left: 50};
            
            const colorScale = d3.scaleSequential(d3.interpolatePurples)
                .domain([0, 0.5]);
            
            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // Add labels
            days.forEach((day, i) => {
                g.append('text')
                    .attr('x', i * cellSize + cellSize/2)
                    .attr('y', -10)
                    .attr('text-anchor', 'middle')
                    .style('font-size', '12px')
                    .text(`Future ${day}`);
                
                g.append('text')
                    .attr('x', -10)
                    .attr('y', i * cellSize + cellSize/2 + 5)
                    .attr('text-anchor', 'end')
                    .style('font-size', '12px')
                    .text(`Past ${day}`);
            });
            
            // Draw heatmap
            data.forEach((row, i) => {
                row.forEach((value, j) => {
                    g.append('rect')
                        .attr('x', j * cellSize)
                        .attr('y', i * cellSize)
                        .attr('width', cellSize - 2)
                        .attr('height', cellSize - 2)
                        .attr('fill', colorScale(value))
                        .attr('stroke', '#ddd');
                    
                    g.append('text')
                        .attr('x', j * cellSize + cellSize/2)
                        .attr('y', i * cellSize + cellSize/2 + 5)
                        .attr('text-anchor', 'middle')
                        .style('font-size', '10px')
                        .style('fill', value > 0.25 ? 'white' : 'black')
                        .text(value.toFixed(2));
                });
            });
        }
        
        function showForecastVisualization() {
            document.getElementById('forecast-visualization').style.display = 'block';
            drawForecastChart();
            
            document.getElementById('final-result').style.display = 'block';
            document.getElementById('final-result').innerHTML = `
                <div class="key-concepts">
                    <h3>Summary: How TFT Processes Time Series</h3>
                    <ul class="concept-list">
                        <li>Multi-modal inputs: static features + time-varying data</li>
                        <li>Variable selection identifies most relevant features automatically</li>
                        <li>LSTM captures temporal patterns and sequences</li>
                        <li>Self-attention learns complex temporal dependencies</li>
                        <li>Quantile outputs provide uncertainty estimates</li>
                        <li>Built-in interpretability shows what drives predictions</li>
                    </ul>
                </div>
            `;
        }
        
        function drawForecastChart() {
            if (typeof d3 === 'undefined') return;
            
            const svg = d3.select('#forecast-chart');
            svg.selectAll("*").remove();
            
            const margin = {top: 20, right: 80, bottom: 50, left: 70};
            const width = svg.node().getBoundingClientRect().width - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;
            
            // Sample data
            const historicalData = [
                {date: new Date('2024-01-15'), value: 42},
                {date: new Date('2024-01-16'), value: 38},
                {date: new Date('2024-01-17'), value: 45},
                {date: new Date('2024-01-18'), value: 52},
                {date: new Date('2024-01-19'), value: 78},
                {date: new Date('2024-01-20'), value: 95},
                {date: new Date('2024-01-21'), value: 72}
            ];
            
            const forecastData = [
                {date: new Date('2024-01-22'), median: 44, lower: 38, upper: 52},
                {date: new Date('2024-01-23'), median: 41, lower: 35, upper: 48},
                {date: new Date('2024-01-24'), median: 47, lower: 40, upper: 55},
                {date: new Date('2024-01-25'), median: 53, lower: 45, upper: 62},
                {date: new Date('2024-01-26'), median: 82, lower: 68, upper: 98},
                {date: new Date('2024-01-27'), median: 102, lower: 85, upper: 120},
                {date: new Date('2024-01-28'), median: 75, lower: 65, upper: 88}
            ];
            
            const allDates = [...historicalData.map(d => d.date), ...forecastData.map(d => d.date)];
            
            const xScale = d3.scaleTime()
                .domain(d3.extent(allDates))
                .range([0, width]);
            
            const yScale = d3.scaleLinear()
                .domain([0, 130])
                .range([height, 0]);
            
            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // Add axes
            g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale).tickFormat(d3.timeFormat('%m/%d')))
                .attr('class', 'axis');
            
            g.append('g')
                .call(d3.axisLeft(yScale))
                .attr('class', 'axis');
            
            // Add grid
            g.append('g')
                .attr('class', 'grid')
                .call(d3.axisLeft(yScale)
                    .tickSize(-width)
                    .tickFormat(''));
            
            // Historical line
            const line = d3.line()
                .x(d => xScale(d.date))
                .y(d => yScale(d.value));
            
            g.append('path')
                .datum(historicalData)
                .attr('class', 'actual-line forecast-line')
                .attr('d', line);
            
            // Forecast area (confidence band)
            const area = d3.area()
                .x(d => xScale(d.date))
                .y0(d => yScale(d.lower))
                .y1(d => yScale(d.upper));
            
            g.append('path')
                .datum(forecastData)
                .attr('class', 'confidence-band')
                .attr('d', area);
            
            // Forecast line
            const forecastLine = d3.line()
                .x(d => xScale(d.date))
                .y(d => yScale(d.median));
            
            g.append('path')
                .datum(forecastData)
                .attr('class', 'prediction-line forecast-line')
                .attr('d', forecastLine);
            
            // Add legend
            const legend = g.append('g')
                .attr('transform', `translate(${width - 100}, 20)`);
            
            legend.append('line')
                .attr('x1', 0)
                .attr('x2', 20)
                .attr('y1', 0)
                .attr('y2', 0)
                .attr('class', 'actual-line forecast-line');
            
            legend.append('text')
                .attr('x', 25)
                .attr('y', 5)
                .text('Historical')
                .style('font-size', '12px');
            
            legend.append('line')
                .attr('x1', 0)
                .attr('x2', 20)
                .attr('y1', 20)
                .attr('y2', 20)
                .attr('class', 'prediction-line forecast-line');
            
            legend.append('text')
                .attr('x', 25)
                .attr('y', 25)
                .text('Forecast')
                .style('font-size', '12px');
            
            // Add labels
            g.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', 0 - margin.left)
                .attr('x', 0 - (height / 2))
                .attr('dy', '1em')
                .style('text-anchor', 'middle')
                .style('font-size', '14px')
                .text('Sales Units');
            
            g.append('text')
                .attr('transform', `translate(${width / 2}, ${height + margin.bottom})`)
                .style('text-anchor', 'middle')
                .style('font-size', '14px')
                .text('Date');
        }
        
        // Data flow animation
        function animateDataFlow() {
            // Implementation similar to transformer visualization
            console.log('Animating TFT data flow...');
        }
        
        function resetAnimation() {
            if (typeof d3 !== 'undefined') {
                d3.select('#architecture-svg').selectAll('.data-flow').remove();
            }
        }
        
        // Initialize first tab when page loads
        window.addEventListener('DOMContentLoaded', function() {
            if (typeof d3 !== 'undefined') {
                initArchitecture();
            }
        });
    </script>
</body>
</html>